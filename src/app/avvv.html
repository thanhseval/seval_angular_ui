<!DOCTYPE html>
<html>

<head>
    <title>Bảng Điều Khiển</title>
    <style>
        /* Định nghĩa các lớp CSS cho nút bật và tắt */
        .button-on {
            background-color: green;
            /* Màu xanh khi bật */
            color: white;
        }

        .button-off {
            background-color: red;
            /* Màu đỏ khi tắt */
            color: white;
        }
    </style>
</head>

<body>
    <h1>Bảng Điều Khiển</h1>

    <div id="devices"></div>

    <script>
        let token = null; // Khởi tạo biến token và đặt giá trị ban đầu là null
        let deviceStatus = {}; // Đối tượng để theo dõi trạng thái của các thiết bị

        // Hàm để đăng nhập và lấy token từ API
        function loginAndGetToken(callback) {
            // Thêm mã đăng nhập ở đây
            const loginData = {
                username: "dat", // Thay đổi thành tên đăng nhập của bạn
                password: "test"  // Thay đổi thành mật khẩu của bạn
            };

            fetch("http://seval.ddns.net:80/users/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(loginData)
            })
                .then(response => response.json())
                .then(responseData => {
                    token = responseData.token; // Lưu token vào biến token
                    console.log("Token lấy được:", token);
                    // Lưu token vào biến hoặc local storage nếu cần
                    // Sau khi lấy được token, bạn có thể gọi các yêu cầu điều khiển thiết bị khác
                    callback(); // Gọi callback để thông báo rằng token đã được lấy
                })
                .catch(error => {
                    console.error("Lỗi khi đăng nhập:", error);
                    // Xử lý lỗi nếu cần
                });
        }

        // Hàm để gửi yêu cầu điều khiển thiết bị lên API qua MQTT
        function sendControlRequest(action, buttonId, oppositeButtonId) {
            if (token === null) {
                console.error("Chưa có token. Vui lòng đăng nhập trước khi gửi yêu cầu.");
                return;
            }

            const endpoint = "http://seval.ddns.net:80/device/mqtt/mqttcontrol"; // Đã thay đổi endpoint API của bạn
            const data = {
                action: action
            };

            fetch(endpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": token // Sử dụng token đã lấy
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(responseData => {
                    console.log(`Đã gửi yêu cầu ${action}`);
                    console.log("Dữ liệu phản hồi từ API:", responseData); // Thêm log dữ liệu phản hồi từ API
                    // Thay đổi màu nền của nút khi nhấn thành công
                    const buttonElement = document.getElementById(buttonId);
                    const oppositeButtonElement = document.getElementById(oppositeButtonId);

                    if (action.endsWith('_ON')) {
                        buttonElement.classList.add('button-on');
                        buttonElement.classList.remove('button-off');
                        oppositeButtonElement.classList.remove('button-on');
                        oppositeButtonElement.classList.remove('button-off');
                        // Khi Bật, tắt khả dụng
                        oppositeButtonElement.disabled = false;
                    } else if (action.endsWith('_OFF')) {
                        buttonElement.classList.add('button-off');
                        buttonElement.classList.remove('button-on');
                        oppositeButtonElement.classList.remove('button-on');
                        oppositeButtonElement.classList.remove('button-off');
                        // Khi Tắt, bật khả dụng
                        oppositeButtonElement.disabled = false;
                    }

                    // Tắt khả dụng nút hiện tại
                    buttonElement.disabled = true;

                    // Cập nhật trạng thái của thiết bị
                    const deviceKey = action.split('_').slice(0, 2).join('_');
                    deviceStatus[deviceKey] = action;
                })
                .catch(error => {
                    console.error(`Lỗi khi gửi yêu cầu ${action}:`, error);
                    // Thêm xử lý lỗi nếu cần
                });
        }

        // Hàm để chuyển đổi trạng thái của thiết bị khi nhấn nút Bật hoặc Tắt
        function toggleDevice(action, buttonId, oppositeButtonId) {
            // Kiểm tra nếu token đã tồn tại, không cần đăng nhập lại
            if (token === null) {
                loginAndGetToken(() => {
                    sendControlRequest(action, buttonId, oppositeButtonId);
                });
            } else {
                // Kiểm tra xem trạng thái hiện tại của thiết bị có khớp với action không
                if (deviceStatus[action.split('_')[0]] !== action) {
                    sendControlRequest(action, buttonId, oppositeButtonId);
                }
            }
        }

        // Hàm để tạo nút cho các thiết bị
        function createDeviceButton(deviceName, onAction, offAction) {
            const container = document.getElementById("devices");
            const deviceHeader = document.createElement("h2");
            deviceHeader.textContent = deviceName;
            container.appendChild(deviceHeader);

            const onButton = document.createElement("button");
            onButton.id = `${onAction}_Button`;
            onButton.textContent = "Bật";
            onButton.onclick = () => toggleDevice(onAction, onButton.id, offButton.id);

            const offButton = document.createElement("button");
            offButton.id = `${offAction}_Button`;
            offButton.className = "button-off";
            offButton.textContent = "Tắt";
            offButton.onclick = () => toggleDevice(offAction, offButton.id, onButton.id);
            offButton.disabled = true;

            container.appendChild(onButton);
            container.appendChild(offButton);
        }

        // Gọi hàm đăng nhập và lấy token khi
        // trang web được tải
        loginAndGetToken(() => {
            console.log("Token đã được lấy và sẵn sàng sử dụng.");

            // Tạo nút cho các thiết bị
            createDeviceButton('Van Điện 1', 'DO_0_ON', 'DO_1_OFF');
            createDeviceButton('Van Điện 2', 'DO_2_ON', 'DO_3_OFF');
            createDeviceButton('Van Điện 3', 'DO_4_ON', 'DO_5_OFF');
        });
    </script>
</body>

</html>